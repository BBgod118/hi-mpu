# Hi3093一键式构建指南

## 1. 概述

本文主要介绍了如何利用oebuild工具，对Hi3093系列板卡进行一键式镜像构建，生成可用于Hi3093 EMMC的烧录镜像，简化构建流程。

## 2. 环境准备

### 2.1 构建机器

准备一个ubuntu x86构建主机环境（建议22.04，依赖Python>=3.8，配置建议预留200G存储）。

### 2.2 安装oebuild

oebuild基于python3实现，具体oebuild用法可参见[安装步骤](https://embedded.pages.openeuler.org/master/oebuild/userguide/install/index.html#oebuild-install)，注意需以普通用户安装oebuild，例：

```shell
sudo apt install python3 python3-pip
# 如果python3和pip模块已安装，请忽略此python3的安装命令
pip install oebuild
# 这里安装oebuild的版本为最新版，可选版本0.0.45.17，命令如pip install oebuild==0.0.45.17
```

### 2.3 安装docker

oebuild构建工具本质上是以来docker容器搭建虚拟环境，进行编译构建。

docker安装：

```shell
sudo apt install docker docker.io -y
sudo groupadd docker
sudo usermod -a -G docker $(whoami)
sudo systemctl-reload && systemctl restart docker
sudo chmod o+rw /var/run/docker.sock
```

## 3. oebuild构建代码准备

基于本章构建方法，已提供[构建准备脚本](https://gitee.com/bbgod118/himpu-oneclick-build)，快速完成oebuild构建代码准备，并修改内核配置文件，拉取仓库执行脚本。执行完成可自动进入构建容器。

详细介绍参考[https://gitee.com/bbgod118/himpu-oneclick-build/blob/master/README.md](https://gitee.com/bbgod118/himpu-oneclick-build/blob/master/README.md)

### 3.1 初始化构建分支代码：

```shell
oebuild init buildwork
```

<span style="color:#0066cc;">**须知**</span>

1. buildwork为构建代码的存放目录，可自定义名称。
2. 可在命令后加上-b参数指定构建分支版本。此处未使用，默认使用master分支，等同于`oebuild init buildwork -b master`。

```shell
cd ./buildwork
oebuild update
```
<span style="color:#0066cc;">**须知**</span>

执行oebuild update完成后，将在 ./buildwork/src/ 目录下载好主构建源码，并初始化构建虚拟环境。

### 3.2 准备mpu_solution源码

通过gitee获取mpu_solution源码，将源码下载至src目录下，并将文件名修改为mpu_solution。

```shell
cd ./src
git clone https://gitee.com/openeuler/hi-mpu.git
mv hi-mpu/ mpu_solution
```

### 3.3 初始化Hi3093构建源码及配置

```shell
cd ../
oebuild generate -p hi3093 -d build_hi3093
```

使用`oebuild generate`初始化构建源码，-p可指定硬件平台，-d为执行构建的目录。

<span style="color:#0066cc;">**须知**</span>
1. 如需使用额外特性功能，可通过-f添加特性参数，可通过`oebuild generate -l`查看支持的配置。
2. 比如需要使用qt组件与UniProton实时系统，可用初始化命令。
    ```shell
    oebuild generate -p hi3093 -f openeuler-qt -f openeuler-mcs -d build_hi3093
    ```
3. 可直接输入`oebuild generate`，使用可视化界面进行参数选择。
    ![alt text](./images/Hi3093一键式构建指南/image.png)

### 3.4 替换内核配置文件defconfig

1. 将所需使用的内核配置文件替换`/home/user/buildwork/src/yocto-meta-openeuler/bsp/meta-hisilicon/recipes-kernel/linux/files/config/hi3093`目录下的defconfig文件。

2. defconfig的修改方法可参考[《openEuler24.03系统QT组件适配指南》中第2章步骤4](./openEuler24.03系统QT组件适配指南.md#步骤4-修改内核配置文件defconfig)

## 4. 构建Hi3093镜像

### 4.1 进入构建虚拟环境

进入初始化时创建的build_hi3093构建目录，执行oebuild bitbake进入容器。
```shell
cd ./build/build_hi3093
oebuild bitbake
```

### 4.2 容器环境准备

1. 由于容器内没有提供vim环境，而Hi3093镜像打包依赖xxd命令，由vim软件包提供此命令。
2. 在构建配置文件中的DISTRO_FEATURES变量追加mpu_solution描述，可在conf/local.conf文件的末尾追加，添加该描述方可构建Hi3093镜像，否则构建出的镜像不包含BSP驱动。

```shell
sudo dnf install vim
echo 'DISTRO_FEATURES:append = " mpu_solution "' >> conf/local.conf
```

### 4.3 构建镜像

```shell
bitbake openeuler-image
```

**输出件：**

构建完成后，输出件位于buildwork/build/build_hi3093/output/[时间戳]。输出件目录如下：

| 文件 | 说明 |
|--|--|
| Hi3093_ext4fs.img | 文件系统，里面包含uImage和设备树 |
| Hi3093_ext4fs_cms.bin | 文件系统签名 |
| u-boot_rsa_4096.bin | uboot |
| Image | 不包含调试信息和符号表的内核镜像文件 |
| vmlinux | 内核镜像文件 |
| zImage | 压缩过的内核镜像文件 |
| openeuler-image-hi3093-20240723064658.rootfs.cpio.gz | 压缩过的文件系统 |
| openeuler-image-hi3093-20240723064658.rootfs.ext4 | ext4 文件系统镜像 |
